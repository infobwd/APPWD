import { supabase } from '../api.js'; import { toast } from '../ui.js';
export async function render(){ const prof=JSON.parse(localStorage.getItem('LINE_PROFILE')||'null'); const lineId=prof?.userId||null; const card=document.getElementById('adminCard'); if(!card) return; if(!lineId){ card.classList.add('hide'); return; } const u=await supabase.from('users').select('role').eq('line_user_id',lineId).maybeSingle(); const isAdmin=!!(u.data && u.data.role==='admin'); card.classList.toggle('hide',!isAdmin); if(!isAdmin) return; const { data }=await supabase.from('settings').select('key,value'); const map={}; (data||[]).forEach(r=>{ try{ map[r.key]=JSON.parse(r.value); }catch{ map[r.key]=r.value; } });
  const byId=id=>document.getElementById(id); byId('set_CHECKIN_START').value=map.CHECKIN_START||'07:30'; byId('set_CHECKIN_ON_TIME_UNTIL').value=map.CHECKIN_ON_TIME_UNTIL||'08:00'; byId('set_SUMMARY_DEFAULT_RANGE_DAYS').value=map.SUMMARY_DEFAULT_RANGE_DAYS??30; byId('set_SLIDER_AUTO_MS').value=map.SLIDER_AUTO_MS??4000; byId('set_BRAND_TITLE').value=map.BRAND_TITLE||'APPWD'; byId('set_BRAND_LOGO_URL').value=map.BRAND_LOGO_URL||'';
  byId('btnSaveSettings').onclick=async()=>{ const payload={ CHECKIN_START:byId('set_CHECKIN_START').value||'07:30', CHECKIN_ON_TIME_UNTIL:byId('set_CHECKIN_ON_TIME_UNTIL').value||'08:00', SUMMARY_DEFAULT_RANGE_DAYS:Number(byId('set_SUMMARY_DEFAULT_RANGE_DAYS').value||30), SLIDER_AUTO_MS:Number(byId('set_SLIDER_AUTO_MS').value||4000), BRAND_TITLE:byId('set_BRAND_TITLE').value||'APPWD', BRAND_LOGO_URL:byId('set_BRAND_LOGO_URL').value||'' }; for(const k of Object.keys(payload)){ await supabase.from('settings').upsert({key:k,value:JSON.stringify(payload[k])}); } toast('บันทึกการตั้งค่าแล้ว'); };
  byId('btnReloadSettings').onclick=()=>location.reload(); }