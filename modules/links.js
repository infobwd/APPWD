import { supabase } from '../api.js';
import { openSheet, closeSheet, toast } from '../ui.js';
const homeGrid=()=>document.getElementById('homeLinks'); const grid=()=>document.getElementById('linkGrid'); const composeBtn=()=>document.getElementById('btnComposeLink');
function skel(n=8){ return Array.from({length:n}).map(()=>`<div class="skeleton h-24"></div>`).join(''); }
function e(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
export async function renderHome(){ homeGrid().innerHTML=skel(8); const {data}=await supabase.from('app_links').select('id,title,url,image_url,category').eq('is_active',true).order('sort_order').limit(8); homeGrid().innerHTML=(data||[]).map(tile).join('')||'<div class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå</div>'; }
export async function render(){ grid().innerHTML=skel(10); const editor=await isEditor(); composeBtn().classList.toggle('hide',!editor); composeBtn().onclick=()=>openComposeSheet(); const {data}=await supabase.from('app_links').select('id,title,url,image_url,category,is_active,sort_order').order('sort_order'); grid().innerHTML=(data||[]).map(r=>tile(r,true,editor)).join('')||'<div class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå</div>'; }
function tile(r,full=false,editor=false){ const img=r.image_url?`<img src="${r.image_url}" class="w-12 h-12 object-cover rounded-2xl border border-[#E6EAF0]" alt="icon">`:`<div class="w-12 h-12 rounded-2xl grid place-items-center bg-brandSoft text-brand">üîó</div>`; const actions=editor&&full?`<div class='flex gap-2 justify-center mt-1'><button class='btn text-xs' onclick='editLink(${r.id})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class='btn text-xs' onclick='deleteLink(${r.id})'>‡∏•‡∏ö</button></div>`:''; return `<div class='flex flex-col items-center gap-1'><a href='${encodeURI(r.url)}' target='_blank' rel='noopener'>${img}<div class='text-[12px] text-center leading-tight mt-1'>${e(r.title)}</div></a>${actions}</div>`; }
window.editLink=async function(id){ const {data:r}=await supabase.from('app_links').select('*').eq('id',id).maybeSingle(); if(!r) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); openEditSheet(r); };
window.deleteLink=async function(id){ if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return; const {error}=await supabase.from('app_links').delete().eq('id',id); if(error) return toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); await import('./links.js').then(m=>m.render()); };
async function isEditor(){ const {data:session}=await supabase.auth.getUser(); const u=session.user; if(!u) return false; const {data}=await supabase.from('editors').select('user_id').eq('user_id',u.id).maybeSingle(); return !!data; }
function openComposeSheet(){ openSheet(`<form id="composeLinkForm" class="grid gap-2 text-sm"><input name="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ/‡∏£‡∏∞‡∏ö‡∏ö" class="border border-[#E6EAF0] rounded p-2" required><input name="url" placeholder="URL" class="border border-[#E6EAF0] rounded p-2" required><input name="image_url" placeholder="‡∏£‡∏π‡∏õ‡πÅ‡∏≠‡∏õ (image_url)" class="border border-[#E6EAF0] rounded p-2"><input name="category" placeholder="‡∏´‡∏°‡∏ß‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="border border-[#E6EAF0] rounded p-2"><div class="grid grid-cols-2 gap-2"><input name="sort_order" type="number" placeholder="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)" class="border border-[#E6EAF0] rounded p-2" value="100"><label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_active" checked> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label></div><div class="flex gap-2"><button class="btn btn-prim">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" id="cancelSheet" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></form>`); document.getElementById('cancelSheet').onclick=closeSheet; const form=document.getElementById('composeLinkForm'); form.onsubmit=async(e)=>{ e.preventDefault(); const fd=new FormData(form); const payload={ title:fd.get('title'), url:fd.get('url'), image_url:fd.get('image_url')||null, category:fd.get('category')||null, sort_order:Number(fd.get('sort_order')||100), is_active:!!fd.get('is_active') }; const {error}=await supabase.from('app_links').insert(payload); if(error){ toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; } toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'); closeSheet(); await import('./links.js').then(m=>m.render()); }; }
function openEditSheet(r){ openSheet(`<form id="editLinkForm" class="grid gap-2 text-sm"><input name="title" class="border border-[#E6EAF0] rounded p-2" value="${e(r.title||'')}"><input name="url" class="border border-[#E6EAF0] rounded p-2" value="${e(r.url||'')}"><input name="image_url" class="border border-[#E6EAF0] rounded p-2" value="${e(r.image_url||'')}" placeholder="‡∏£‡∏π‡∏õ‡πÅ‡∏≠‡∏õ (image_url)"><input name="category" class="border border-[#E6EAF0] rounded p-2" value="${e(r.category||'')}"><div class="grid grid-cols-2 gap-2"><input name="sort_order" type="number" class="border border-[#E6EAF0] rounded p-2" value="${r.sort_order??100}"><label class="text-sm flex items-center gap-2"><input type="checkbox" name="is_active" ${r.is_active?'checked':''}> ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label></div><div class="flex gap-2"><button class="btn btn-prim">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" id="cancelSheet" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></form>`); document.getElementById('cancelSheet').onclick=closeSheet; const form=document.getElementById('editLinkForm'); form.onsubmit=async(e)=>{ e.preventDefault(); const fd=new FormData(form); const upd={ title:fd.get('title'), url:fd.get('url'), image_url:fd.get('image_url')||null, category:fd.get('category')||null, sort_order:Number(fd.get('sort_order')||100), is_active:!!fd.get('is_active') }; const {error}=await supabase.from('app_links').update(upd).eq('id',r.id); if(error){ toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; } toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß'); closeSheet(); await import('./links.js').then(m=>m.render()); }; }