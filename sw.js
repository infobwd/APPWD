const CACHE='appwd-v4.3';const ASSETS=['.','./index.html','./app.js','./ui.js','./api.js','./config.js','./modules/news.js','./modules/links.js','./modules/scan.js','./modules/checkin.js','./modules/notify.js','./push.js','./manifest.json'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)));self.skipWaiting();});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));self.clients.claim();});self.addEventListener('fetch',e=>{const url=new URL(e.request.url);if(url.origin===location.origin){if(ASSETS.includes(url.pathname)||url.pathname.endsWith('.js')||url.pathname.endsWith('.css')){e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));return;}if(url.pathname.match(/\.(png|jpg|jpeg|gif|webp)$/)){e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{const copy=resp.clone();caches.open(CACHE).then(c=>c.put(e.request,copy));return resp;})));return;}}});self.addEventListener('push',event=>{let data={};try{data=event.data?.json()||{}}catch(_){}const title=data.title||'แจ้งเตือน';const options={body:data.body||'',icon:'./icons/icon-192.png',badge:'./icons/icon-192.png',data:{url:data.url||'./'}};event.waitUntil(self.registration.showNotification(title,options));});self.addEventListener('notificationclick',event=>{event.notification.close();const url=event.notification.data?.url||'./';event.waitUntil((async()=>{const all=await clients.matchAll({type:'window',includeUncontrolled:true});const found=all.find(c=>c.url.includes('/APPWD/'));if(found){found.focus();found.navigate(url);}else{clients.openWindow(url);}})());});